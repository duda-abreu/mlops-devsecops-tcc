name: CI/CD Pipeline MLOps DevSecOps

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Pipeline sem práticas MLOps
  baseline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v3

      - name: Criar pasta de reports
        run: mkdir -p reports

      - name: Instalar dependências
        run: pip install -r requirements.txt

      - name: Rodar script ML
        run: |
          START=$(date +%s)
          python 01_model_training/train_model.py
          END=$(date +%s)
          echo $((END-START)) > reports/train_time_baseline.txt

      - name: Upload de reports Baseline
        uses: actions/upload-artifact@v4
        with:
          name: baseline-reports
          path: reports/

  # Pipeline COM práticas MLOps e DevSecOps
  mlops-devsecops:
    runs-on: ubuntu-latest
    needs: baseline
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Criar pasta de reports
        run: mkdir -p reports

      - name: Instalar dependências
        run: |
          pip install -r requirements.txt
          pip install bandit safety

      - name: Linter (Flake8)
        run: |
          START=$(date +%s)
          flake8 01_model_training 02_model_serving_api || true
          END=$(date +%s)
          echo $((END-START)) > reports/lint_time.txt

      - name: Testes Unitários
        run: |
          START=$(date +%s)
          pytest tests/ || true
          END=$(date +%s)
          echo $((END-START)) > reports/test_time.txt

      - name: Análise de Segurança (Bandit)
        run: |
          START=$(date +%s)
          bandit -r 01_model_training 02_model_serving_api -f json -o reports/bandit_report.json || true
          END=$(date +%s)
          echo $((END-START)) > reports/bandit_time.txt
          python scripts/parse_bandit.py reports/bandit_report.json > reports/bandit_summary.txt

      - name: Análise de Vulnerabilidades (Safety)
        run: |
          START=$(date +%s)
          safety check -r requirements.txt --full-report --json > reports/safety_report.json || true
          END=$(date +%s)
          echo $((END-START)) > reports/safety_time.txt

      - name: Build Docker Image
        run: docker build -t tcc-mlops:latest .

      - name: Scan de Imagem (Trivy)
        run: |
          START=$(date +%s)
          trivy image --format json --output reports/trivy_report.json tcc-mlops:latest || true
          END=$(date +%s)
          echo $((END-START)) > reports/trivy_time.txt

      - name: Rodar script ML com monitoramento
        run: |
          START=$(date +%s)
          python 01_model_training/train_model.py
          END=$(date +%s)
          echo $((END-START)) > reports/train_time_mlops.txt

      - name: Calcular métricas do pipeline
        run: |
          python scripts/metrics.py reports > reports/metrics_summary.json
          cat reports/metrics_summary.json

      - name: Upload de reports MLOps
        uses: actions/upload-artifact@v4
        with:
          name: mlops-reports
          path: reports/
